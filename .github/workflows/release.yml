name: Create GitHub Release
'on':
  workflow_dispatch:
    inputs:
      version:
        description: Release version
        required: true
      release_body:
        description: Changelog or release notes
        required: false
  push:
    tags:
    - v*.*.*
jobs:
  build-windows-exe:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          cd src
          pip install -r requirements.txt
          pip install pyinstaller
          pip install -e .
      - name: Build EXE with PyInstaller
        run: |
          cd src
          pyinstaller --onefile `
            --add-data "shtest_compiler/config;./shtest_compiler/config" `
            --add-data "shtest_compiler/regex_config.yml;./shtest_compiler/regex_config.yml" `
            shtest_compiler/shtest.py
          pyinstaller --onefile `
            --add-data "shtest_compiler/config;./shtest_compiler/config" `
            --add-data "shtest_compiler/regex_config.yml;./shtest_compiler/regex_config.yml" `
            shtest_compiler/run_all.py
      - name: Upload EXE artifacts
        uses: actions/upload-artifact@v4
        with:
          name: knightbatch-exe
          path: |
            src/dist/shtest.exe
            src/dist/run_all.exe

  create_release:
    runs-on: ubuntu-latest
    needs: build-windows-exe
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

          
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: vscode/package-lock.json


      - name: Install VS Code extension dependencies
        run: |
          cd vscode
          npm ci


      - name: Build VS Code extension
        run: |
          cd vscode
          npm run compile


      - name: Install vsce
        run: npm install -g @vscode/vsce@latest


      - name: Package VS Code extension
        run: |
          cd vscode
          vsce package -o ../knightbatch-shtest.vsix

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.MARKETPLACE_KEY }}
        run: |
          vsce publish --packagePath knightbatch-shtest.vsix --pat $VSCE_PAT

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install MkDocs and plugins
        run: |
          pip install mkdocs-material mkdocs-macros-plugin mkdocs-minify-plugin
          npm install -g @mermaid-js/mermaid-cli
      - name: Generate architecture diagram
        run: |
          npx mmdc --no-sandbox -i docs/docs/assets/architecture.mmd -o docs/docs/assets/architecture.png || echo "Mermaid generation failed (possibly headless issue)."
      - name: Build documentation
        run: |
          cd docs
          mkdocs build
      - name: Download Windows EXE artifacts
        uses: actions/download-artifact@v4
        with:
          name: knightbatch-exe
          path: exe-artifacts/
      - name: Create release package
        run: |
          mkdir -p release
          cp knightbatch-shtest.vsix release/
          cp -r docs/site release/docs
          cp -r src release/src
          cp -r docs release/docs-source
          cp README.md release/
          cp LICENSE release/
          tar czf knightbatch-release.tar.gz release/
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: "\U0001F680 Nouvelle version : ${{ github.ref_name }}"
          files: |
            knightbatch-release.tar.gz
            exe-artifacts/shtest.exe
            exe-artifacts/run_all.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy_docs:
    runs-on: ubuntu-latest
    needs: build-windows-exe
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: |
          pip install mkdocs-material mkdocs-macros-plugin mkdocs-minify-plugin
          npm install -g @mermaid-js/mermaid-cli
      - name: Generate architecture diagram
        run: |
          npx mmdc --no-sandbox -i docs/docs/assets/architecture.mmd -o docs/docs/assets/architecture.png || echo "Mermaid generation failed (possibly headless issue)."
      - name: Build documentation
        run: |
          cd docs
          mkdocs build
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/site
          cname: knightbatch.github.io
